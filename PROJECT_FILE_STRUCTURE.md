# LogiMAS â€” Project file structure

This document lists the top-level files and folders in the repository and gives a short description for each file or folder. It is generated from the workspace snapshot provided.


- README.md
  - Project-level readme with overview and high-level instructions (top-level project documentation).

- apps/
  - web/
    - eslint.config.mjs
      - ESLint configuration for the Next.js frontend.
    - middleware.ts.disabled
      - A disabled/renamed middleware file for Next.js; likely used for routing/auth before being disabled.
    - next-env.d.ts
      - TypeScript types file automatically generated by Next.js.
    - next.config.ts
      - Next.js configuration file for the frontend app.
    - package.json
      - Frontend package manifest and scripts (npm/yarn), dependencies for the web app.
    - postcss.config.mjs
      - PostCSS configuration for Tailwind / CSS processing.
    - README.md
      - Frontend-specific readme with run instructions for `apps/web`.
    - tsconfig.json
      - TypeScript configuration for the frontend app.
    - app/
      - globals.css
        - Global stylesheet for the Next.js app.
      - layout.tsx
        - Top-level layout component for the Next.js app.
      - page.tsx
        - Root page component (landing or main entry).
      - dashboard/
        - layout.tsx
          - Layout for dashboard routes.
        - page.tsx
          - Dashboard main page.
        - analysis/page.tsx
          - Analysis subpage under dashboard.
        - chat/page.tsx
          - Chat subpage under dashboard.
        - knowledge/page.tsx
          - Knowledge base subpage under dashboard.
        - tracking/page.tsx
          - Tracking subpage under dashboard.
      - login/page.tsx
        - Login page component.
      - signup/page.tsx
        - Signup page component.
      - unauthorized/
        - Directory for unauthorized page(s).
    - components/
      - auth/
        - AuthForm.tsx
          - Authentication form component used by login/signup pages.
      - charts/
        - DailyPerformanceChart.tsx
          - Chart component used on dashboards.
      - dashboard/
        - Sidebar.tsx
          - Sidebar layout component for dashboard navigation.
      - maps/
        - LiveTrackingMap.tsx
          - Map component to show live vehicle/asset tracking.
      - ui/
        - AgentChat.tsx
          - UI component that talks to the agent backend (`/agent/invoke`).
        - RealtimeTelemetry.tsx
          - Component showing incoming telemetry in realtime.
        - ShipmentChat.tsx
          - Chat UI specialized for shipment conversations.
    - contexts/
      - AuthContext.tsx
        - React context for auth state and helpers.
        - Responsibilities: holds current user, roles, token management, login/logout helpers and helper hooks (e.g. useAuth) used across the frontend.
    - lib/
      - apiClient.ts
        - Utility to call backend APIs from the frontend.
        - Responsibilities: unified API call wrapper that injects auth tokens, handles 401/403 responses, and centralizes base URL and headers.
      - supabaseClient.ts
        - Supabase client wrapper used by frontend for auth and data access.
        - Responsibilities: initializes Supabase client, exposes sign-in/sign-up helpers and role retrieval helpers.
    - public/
      - Static assets for the frontend (images, icons, etc.).
    - src/
      - components/
        - auth/
      - contexts/
      - pages/
      - (likely legacy or source-mapped code for some parts of the frontend)

- packages/
  - agents/
    - requirements.txt
      - Python dependencies for the agents package.
    - logimas_agents/
      - __init__.py
        - Package marker for Python package.
      - auth.py.disabled
        - Disabled authentication helper/file for agent backend.
      - main.py
        - FastAPI app entrypoint exposing `/agent/invoke` (agent backend server).
        - Responsibilities: load environment, mount routes, include authentication dependency middleware used by agents and tools, and configure CORS and logging.
      - agents/
        - __init__.py
        - coordinator.py
          - Orchestrates agent interactions and coordinates multi-agent flow.
        - cost.py
          - Cost estimation agent logic or executor.
        - mobility.py
          - Mobility-related agent logic (routing, vehicle assignment).
        - shared.py
          - Shared utilities and helpers used by multiple agents.
        - supplier.py
          - Supplier-side agent for procurement/supplier decisions.
        - tracking.py
          - Tracking agent that queries tools/external stores for live status.
        - warehouse.py
          - Warehouse agent handling packing, storage, and warehouse queries.
      - chains/
        - __init__.py
        - graph.py
          - The state graph / router (LangGraph) that routes queries to agents based on keywords.
          - Responsibilities: determines which agent nodes can be called for a request; will check user role/permissions before allowing certain nodes to run (e.g., supplier/warehouse operations restricted to elevated roles).
      - schemas/
        - __init__.py
        - graph_state.py
          - Pydantic models for graph state used in routing.
        - outputs.py
          - Pydantic models for agent outputs / response shapes.
      - tools/
        - __init__.py
        - database.py
          - Supabase client wrapper and helper functions like `log_agent_decision`.
          - Responsibilities: central place to perform RBAC checks against `users`/`roles` tables and to log agent decisions.
        - routing.py
          - Routing utilities and helper functions for path calculations.
        - vector_store.py
          - Vector store interface (embeddings) used for RAG retrieval.

- data_pipeline/
  - requirements.txt
    - Python dependencies for data pipeline scripts.
  - data/
    - generated/
      - customers.csv
      - orders.csv
      - shipments.csv
      - vehicles.csv
      - warehouses.csv
      - (generated sample data used for development/testing)
    - raw/
      - incident_reports/
        - 20250927_I405_shutdown.txt
        - 20251003_weather_flood_warning.txt
        - 20251004_supplier_delay_gpi.txt
        - sample_report.txt
        - sop_fragile_goods_handling.txt
        - (collection of raw incident text reports used for ingestion)
  - scripts/
    - 04_run_telemetry_simulator.py
      - Telemetry simulator script to generate live-like telemetry streams.
    - embed_and_ingest.py
      - Script that computes embeddings and ingests documents into the vector store.
    - seed_database.py
      - Script to seed example data into the project's database (supabase/local DB).

- supabase/
  - config.toml
    - Supabase project configuration for local development.
  - migrations/
    - 0001_initial_schema.sql
      - SQL migration that defines tables like `agent_audit_logs`, shipments, documents etc.
      - RBAC-related schema notes: ensure the migration includes tables for `users`, `roles`, `user_roles`, and `role_permissions` (or a similar mapping) so both frontend and backend can query user roles and permission sets. If not present, add a migration that creates:
        - `roles(id, name, description)`
        - `permissions(id, name, description)`
        - `role_permissions(role_id, permission_id)`
        - `user_roles(user_id, role_id)`

Role Based Authentication & Authorization (RBAC) implementation plan

Overview
- Implement RBAC across both frontend (Next.js) and backend (FastAPI agents). Roles will be assigned in Supabase and used to gate UI elements and API endpoints.

User/Role model (supabase)
- `users` (existing Supabase auth users table)
- `roles` (admin, dispatcher, operator, viewer, supplier)
- `user_roles` (assign many roles to a user)
- `permissions` (optional, fine-grained perms)
- `role_permissions` (maps roles to permissions if using permissions)

Frontend changes (files to update)
- `apps/web/contexts/AuthContext.tsx`
  - Store user + roles, provide `hasRole(roleName)` helper, and expose `auth.fetchRoles()` that queries backend or Supabase on login.
  - Persist selected role or enforce primary role from the user object.
- `apps/web/lib/supabaseClient.ts`
  - Add helper to read custom claims or call a protected endpoint that returns roles for current user.
- `apps/web/components/ui/AgentChat.tsx` and other UI components
  - Hide or disable UI actions based on `useAuth().hasRole(...)`. Example: only users with `operator` or `admin` can call agents that mutate state.

Backend changes (files to update)
- `packages/agents/logimas_agents/main.py`
  - Add an authentication dependency that validates JWT or Supabase session cookie. Expose a dependency `get_current_user` that returns user object and roles.
  - Add middleware to decode tokens and attach user/roles to request state for easy checks.
- `packages/agents/logimas_agents/tools/database.py`
  - Add helpers `get_roles_for_user(user_id)` and `user_has_role(user_id, role_name)` to be used by tools and agents.
- `packages/agents/logimas_agents/chains/graph.py`
  - Before routing to a node, verify the user's roles/permissions. Deny nodes that require elevated permissions and return a clear error.
- `packages/agents/logimas_agents/agents/*.py`
  - For any agent that performs sensitive operations (warehouse, supplier, cost updates), add an explicit role check at the start and return 403-like errors when not authorized.

API contract & endpoints
- Keep `/agent/invoke` as the main entry; require Authorization header `Bearer <token>` or Supabase session cookie.
- Add endpoint `GET /auth/roles` (or reuse Supabase JWT custom claims) to return roles for the current user.

Supabase considerations
- Use Supabase Row Level Security (RLS) policies for DB protection in addition to application-level checks where possible.
- Consider adding custom JWT claims for roles so the frontend can quickly read roles from the session token without an extra network call.

Developer checklist for implementation
1. Ensure `supabase/migrations/0001_initial_schema.sql` includes RBAC tables or create `0002_rbac_schema.sql` to add them.
2. Update `packages/agents/logimas_agents/tools/database.py` with role retrieval helpers and tests.
3. Implement `get_current_user` dependency in `main.py` and wire it into routes.
4. Update `chains/graph.py` to check roles before routing to sensitive nodes.
5. Update `apps/web/contexts/AuthContext.tsx` to fetch roles and export `hasRole` helper.
6. Audit UI components and restrict actions based on roles.
7. Add integration tests (FastAPI + test tokens) that verify 403 responses for unauthorized roles.

Notes & alternatives
- If you prefer a simpler model, implement role checks only in the backend and use minimal frontend gating (show/hide UI based on server-supplied allowed actions). This reduces risk of front-end/ back-end mismatch.
- For fine-grained permissions, add `permissions` and `role_permissions` tables and store permission names (e.g., `invoke_agent:warehouse:update`) and check them instead of roles.

Next steps I can take for you
- Implement the RBAC DB migration file and create `supabase/migrations/0002_rbac_schema.sql`.
- Implement role helpers in `packages/agents/logimas_agents/tools/database.py` and add unit tests.
- Wire `get_current_user` authentication dependency in `main.py` and protect `/agent/invoke` so it uses the dependency.
- Update frontend `AuthContext.tsx` to fetch roles and add `hasRole` helper.



Notes
- This file was generated from the provided workspace snapshot and may omit some files or deeper nested files not shown in the snapshot.
- If you'd like, I can: 
  - expand descriptions for any specific file, 
  - include file sizes and last-modified timestamps, or
  - include a full recursive tree with every file (may be large).

